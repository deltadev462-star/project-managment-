generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum WorkspaceRole {
    ADMIN
    MEMBER
}

enum TaskStatus {
    TODO
    IN_PROGRESS
    DONE
}

enum TaskType {
    TASK
    BUG
    FEATURE
    IMPROVEMENT
    OTHER
}

enum ProjectStatus {
    ACTIVE
    PLANNING
    COMPLETED
    ON_HOLD
    CANCELLED
}

enum Priority {
    LOW
    MEDIUM
    HIGH
}

enum RequirementStatus {
    DRAFT
    REVIEW
    APPROVED
    IMPLEMENTED
    VERIFIED
    CLOSED
}

model User {
    id        String   @id
    name      String
    email     String   @unique
    image     String   @default("")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    workspaces           WorkspaceMember[]
    projects             Project[]               @relation("ProjectOwner")
    tasks                Task[]                  @relation("TaskAssignee")
    comments             Comment[]
    ownedWorkspaces      Workspace[]
    ProjectMember        ProjectMember[]
    subscriptions        Subscription[]
    ownedRequirements    Requirement[]           @relation("RequirementOwner")
    stakeholderRelations StakeholderRequirement[]
    requirementComments  RequirementComment[]
    requirementHistory   RequirementHistory[]
}

enum PlanType {
    FREE
    STARTER
    PROFESSIONAL
}

enum SubscriptionStatus {
    ACTIVE
    CANCELLED
    EXPIRED
    TRIALING
}

model PricingPlan {
    id                String         @id @default(uuid())
    name              String         @unique
    type              PlanType       @unique
    price             Float          @default(0)
    currency          String         @default("USD")
    interval          String?        // "month" or "year"
    description       String?
    features          Json           @default("[]")
    stripeProductId   String?        @unique
    stripePriceId     String?        @unique
    isActive          Boolean        @default(true)
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt

    // Plan limits
    maxProjects       Int            @default(1)
    maxWorkspaces     Int            @default(1)
    maxTeamMembers    Int            @default(3)

    subscriptions     Subscription[]
}

model Subscription {
    id                      String              @id @default(uuid())
    userId                  String
    planId                  String
    stripeSubscriptionId    String?             @unique
    stripeCustomerId        String?
    status                  SubscriptionStatus  @default(ACTIVE)
    startDate               DateTime            @default(now())
    endDate                 DateTime?
    cancelledAt             DateTime?
    createdAt               DateTime            @default(now())
    updatedAt               DateTime            @updatedAt

    user                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    plan                    PricingPlan         @relation(fields: [planId], references: [id])

    @@index([userId])
    @@index([stripeSubscriptionId])
}

model Workspace {
    id          String   @id
    name        String
    slug        String   @unique
    description String?
    settings    Json     @default("{}")
    ownerId     String
    createdAt   DateTime @default(now())
    image_url   String   @default("")
    updatedAt   DateTime @updatedAt

    members  WorkspaceMember[]
    projects Project[]
    owner    User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model WorkspaceMember {
    id          String        @id @default(uuid())
    userId      String
    workspaceId String
    message     String        @default("")
    role        WorkspaceRole @default(MEMBER)
    user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId]) // prevent duplicate membership
}

model Project {
    id          String          @id @default(uuid())
    name        String
    description String?
    priority    Priority        @default(MEDIUM)
    status      ProjectStatus   @default(ACTIVE)
    start_date  DateTime?
    end_date    DateTime?
    team_lead   String
    workspaceId String
    progress    Int             @default(0)
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt
    members     ProjectMember[]

    owner     User      @relation("ProjectOwner", fields: [team_lead], references: [id], onDelete: Cascade)
    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    tasks        Task[]
    requirements Requirement[]
    stakeholders Stakeholder[]
    meetings     Meeting[]
}

model ProjectMember {
    id        String  @id @default(uuid())
    userId    String
    projectId String
    user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([userId, projectId]) // prevent duplicate membership
}

model Task {
    id          String     @id @default(uuid())
    projectId   String
    title       String
    description String?
    status      TaskStatus @default(TODO)
    type        TaskType   @default(TASK)
    priority    Priority   @default(MEDIUM)
    assigneeId  String
    due_date    DateTime
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt

    project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
    assignee     User              @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
    comments     Comment[]
    requirements RequirementTask[]
}

model Comment {
    id        String   @id @default(uuid())
    content   String
    userId    String
    taskId    String
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// Stakeholder model
model Stakeholder {
    id          String                   @id @default(uuid())
    projectId   String
    name        String
    email       String?
    role        String
    department  String?
    phone       String?
    notes       String?
    createdAt   DateTime                 @default(now())
    updatedAt   DateTime                 @updatedAt

    project      Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    requirements StakeholderRequirement[]
    meetings     MeetingParticipant[]
}

// Meeting model
model Meeting {
    id          String               @id @default(uuid())
    projectId   String
    title       String
    description String?
    meetingDate DateTime
    duration    Int?                 // in minutes
    location    String?
    notes       String?
    createdAt   DateTime             @default(now())
    updatedAt   DateTime             @updatedAt

    project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
    participants MeetingParticipant[]
    requirements MeetingRequirement[]
}

// Meeting participants
model MeetingParticipant {
    id            String      @id @default(uuid())
    meetingId     String
    stakeholderId String
    attended      Boolean     @default(false)

    meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
    stakeholder Stakeholder @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)

    @@unique([meetingId, stakeholderId])
}

// Requirement model
model Requirement {
    id          String            @id @default(uuid())
    projectId   String
    title       String
    description String?
    type        String            @default("FUNCTIONAL") // FUNCTIONAL, NON_FUNCTIONAL, BUSINESS, TECHNICAL
    status      RequirementStatus @default(DRAFT)
    priority    Priority          @default(MEDIUM)
    ownerId     String
    version     Int               @default(1)
    createdAt   DateTime          @default(now())
    updatedAt   DateTime          @updatedAt

    project         Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    owner           User                     @relation("RequirementOwner", fields: [ownerId], references: [id])
    stakeholders    StakeholderRequirement[]
    attachments     RequirementAttachment[]
    comments        RequirementComment[]
    history         RequirementHistory[]
    taskLinks       RequirementTask[]
    meetingLinks    MeetingRequirement[]
}

// Stakeholder-Requirement relationship
model StakeholderRequirement {
    id            String      @id @default(uuid())
    stakeholderId String
    requirementId String
    userId        String?     // If stakeholder is also a user
    role          String      @default("REVIEWER") // OWNER, REVIEWER, APPROVER, INFORMED
    createdAt     DateTime    @default(now())

    stakeholder Stakeholder @relation(fields: [stakeholderId], references: [id], onDelete: Cascade)
    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

    @@unique([stakeholderId, requirementId])
}

// Requirement attachments
model RequirementAttachment {
    id            String      @id @default(uuid())
    requirementId String
    fileName      String
    fileUrl       String      // SharePoint URL
    fileSize      Int?
    mimeType      String?
    uploadedAt    DateTime    @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
}

// Requirement comments
model RequirementComment {
    id            String      @id @default(uuid())
    requirementId String
    userId        String
    content       String
    createdAt     DateTime    @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Requirement history/change log
model RequirementHistory {
    id            String   @id @default(uuid())
    requirementId String
    userId        String
    action        String   // CREATED, UPDATED, STATUS_CHANGED, PRIORITY_CHANGED, etc.
    changes       Json     @default("{}")
    version       Int
    createdAt     DateTime @default(now())

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    user        User        @relation(fields: [userId], references: [id])
}

// Requirement-Task traceability
model RequirementTask {
    id            String      @id @default(uuid())
    requirementId String
    taskId        String

    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
    task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

    @@unique([requirementId, taskId])
}

// Meeting-Requirement relationship
model MeetingRequirement {
    id            String      @id @default(uuid())
    meetingId     String
    requirementId String
    discussed     Boolean     @default(false)

    meeting     Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
    requirement Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

    @@unique([meetingId, requirementId])
}
